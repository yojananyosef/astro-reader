---
import { ViewTransitions } from "astro:transitions";
import "../../../styles/dyslexia-theme.css";
import ReaderControls from "../components/ReaderControls";
import SidebarNav from "../components/SidebarNav";
import booksIndex from "../../../data/books-index.json";

const books = booksIndex;
---

<html lang="es">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <title>Biblia Accesible</title>
        <ViewTransitions />
        <style is:inline>
            :root {
                --sidebar-width: 16rem;
                --sidebar-collapsed-width: 0rem;
                --sidebar-current-width: var(--sidebar-width);
            }

            /* Sincronizar variable CSS con el estado del sidebar */
            [data-sidebar-collapsed="true"] {
                --sidebar-current-width: var(--sidebar-collapsed-width);
            }

            /* Estructura Grid Base - Comportamiento de Aplicaci√≥n */
            .app-grid {
                display: grid;
                grid-template-columns: var(--sidebar-current-width) 1fr;
                grid-template-rows: 4rem 1fr;
                grid-template-areas:
                    "nav nav"
                    "sidebar main";
                min-height: 100vh;
            }

            .grid-nav { 
                grid-area: nav;
                position: sticky;
                top: 0;
                z-index: 50;
                height: 4rem;
                background-color: var(--color-bg);
            }
            .grid-sidebar { 
                grid-area: sidebar;
                position: sticky;
                top: 4rem; /* Debajo del nav */
                z-index: 40;
                height: calc(100vh - 4rem);
                width: var(--sidebar-current-width);
                background-color: var(--color-bg);
                overflow: hidden;
            }
            .grid-main { 
                grid-area: main;
                min-width: 0;
            }

            /* Mobile: Sidebar sobrepuesto o escondido */
            @media (max-width: 767px) {
                :root {
                    --sidebar-current-width: 0rem;
                }
                .app-grid {
                    grid-template-columns: 0 1fr;
                    grid-template-areas:
                        "nav nav"
                        "main main";
                }
            }
        </style>
        <script is:inline>
            function applySidebarState() {
                try {
                    var s = localStorage.getItem("reader-sidebar-collapsed");
                    var collapsed = s === "true";
                    document.documentElement.setAttribute(
                        "data-sidebar-collapsed",
                        collapsed ? "true" : "false",
                    );
                } catch (e) {}
            }
            applySidebarState();
            document.addEventListener("astro:after-swap", applySidebarState);
            document.addEventListener("astro:before-swap", (ev) => {
                var s = localStorage.getItem("reader-sidebar-collapsed");
                var collapsed = s === "true";
                ev.newDocument.documentElement.setAttribute(
                    "data-sidebar-collapsed",
                    collapsed ? "true" : "false",
                );
            });
        </script>
    </head>
    <body class="overflow-x-hidden">
        <script is:inline>
            function applyInitialPrefs() {
                try {
                    var defaultPrefs = {
                        theme: "light",
                        fontSize: 18,
                        lineHeight: 1.6,
                        letterSpacing: 0.02,
                        wordSpacing: 0.16,
                        fontFamily: "sans",
                    };

                    var stored = localStorage.getItem("bible-reader-prefs");
                    var prefs = stored
                        ? Object.assign({}, defaultPrefs, JSON.parse(stored))
                        : defaultPrefs;

                    var body = document.body;
                    if (!body) return;

                    body.setAttribute("data-theme", prefs.theme);
                    body.setAttribute("data-font", prefs.fontFamily);
                    body.style.setProperty(
                        "--reader-font-size",
                        prefs.fontSize + "px",
                    );
                    body.style.setProperty(
                        "--reader-line-height",
                        prefs.lineHeight,
                    );
                    body.style.setProperty(
                        "--reader-letter-spacing",
                        prefs.letterSpacing + "em",
                    );
                    body.style.setProperty(
                        "--reader-word-spacing",
                        prefs.wordSpacing + "em",
                    );
                } catch (e) {
                    console.error("Error applying theme", e);
                }
            }

            // Run on initial load
            applyInitialPrefs();

            // Run after each ViewTransition swap
            document.addEventListener("astro:after-swap", applyInitialPrefs);
        </script>
        <script>
            import "../scripts/init-client";
        </script>

        <div class="app-grid" transition:animate="none">
            <header class="grid-nav" transition:persist="app-header">
                <ReaderControls 
                    client:only="preact" 
                    books={books} 
                />
            </header>
            
            <aside class="grid-sidebar" transition:persist="app-sidebar">
                <SidebarNav
                    client:only="preact"
                    books={books}
                    showTrigger={false}
                    mode="inline"
                />
            </aside>

            <main class="grid-main" transition:animate="fade">
                <div class="p-6">
                    <slot />
                </div>
            </main>
        </div>
    </body>
</html>
