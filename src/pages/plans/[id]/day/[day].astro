---
import ReaderLayout from "../../../../features/reader/layouts/ReaderLayout.astro";
import PlanDay from "../../../../features/plans/components/PlanDay";
import plans from "../../../../data/plans.json";

export function getStaticPaths() {
  const paths: any[] = [];
  plans.forEach((plan) => {
    for (let day = 1; day <= plan.durationDays; day++) {
      paths.push({
        params: { id: plan.id, day: day.toString() },
        props: { plan, dayNum: day },
      });
    }
  });
  return paths;
}

const { plan, dayNum: parsedDay } = Astro.props;

// Cargar contenido dinámico del plan si existe
let dayContent = {
  title: "",
  bible: [],
  egw: [],
  description: "",
};

try {
  // En modo estático durante el build, Astro.url.origin puede no ser útil.
  // Intentamos cargar el archivo localmente si es posible, o simplemente dejamos que el componente lo maneje.
  // Pero aquí estamos intentando pasar props iniciales.
  const response = await fetch(new URL(`/data/plan-content/${plan.id}.json`, Astro.url));
  if (response.ok) {
    const data = await response.json();
    if (data[parsedDay]) {
      dayContent = data[parsedDay];
    }
  }
} catch (e) {
  console.error("Error loading plan content:", e);
}

const readings = dayContent.bible || [];
const egwReadings = dayContent.egw || [];
---

<ReaderLayout>
  <PlanDay
    client:only="preact"
    planId={plan.id}
    planTitle={plan.title}
    day={parsedDay}
    readings={readings}
    egwReadings={egwReadings}
    description={dayContent.description}
    dayTitle={dayContent.title}
  />
</ReaderLayout>