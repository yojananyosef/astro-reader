---
import ReaderLayout from "../../../../features/reader/layouts/ReaderLayout.astro";
import ReaderControls from "../../../../features/reader/components/ReaderControls";
import SidebarNav from "../../../../features/reader/components/SidebarNav";
import PlanDay from "../../../../features/plans/components/PlanDay";
import booksIndex from "../../../../data/books-index.json";
import plans from "../../../../data/plans.json";

const books = booksIndex;
const { id, day } = Astro.params;
const plan = (plans as any[]).find((p) => p.id === id);
if (!plan) {
  return Astro.redirect("/plans");
}

const parsedDay = Number.parseInt(day ?? "", 10);
if (
  !Number.isFinite(parsedDay) ||
  parsedDay < 1 ||
  parsedDay > plan.durationDays
) {
  return Astro.redirect(`/plans/${id}`);
}

// Cargar contenido dinÃ¡mico del plan si existe
let dayContent = {
  title: "",
  bible: [],
  egw: [],
  description: "",
};

try {
  // Intentamos cargar el archivo JSON correspondiente al plan
  const planContents = import.meta.glob(
    "../../../../data/plan-content/*.json",
    { eager: true },
  );
  const contentFile = Object.entries(planContents).find(([path]) =>
    path.endsWith(`${id}.json`),
  );

  if (contentFile) {
    const data = (contentFile[1] as any).default || contentFile[1];
    if (data[parsedDay]) {
      dayContent = data[parsedDay];
    }
  }
} catch (e) {
  console.error("Error loading plan content:", e);
}

const readings = dayContent.bible || [];
const egwReadings = dayContent.egw || [];
---

<ReaderLayout>
  <div style="padding-top: 4rem;">
    <ReaderControls client:only="preact" books={books} />
    <div class="flex gap-6">
      <SidebarNav
        client:only="preact"
        books={books}
        showTrigger={false}
        mode="inline"
      />
      <div class="flex-1">
        <PlanDay
          client:only="preact"
          planId={plan.id}
          planTitle={plan.title}
          day={parsedDay}
          readings={readings}
          egwReadings={egwReadings}
          description={dayContent.description}
          dayTitle={dayContent.title}
        />
      </div>
    </div>
  </div>
</ReaderLayout>
