---
import ReaderLayout from "../../../../features/reader/layouts/ReaderLayout.astro";
import PlanDay from "../../../../features/plans/components/PlanDay";
import plans from "../../../../data/plans.json";

const { id, day } = Astro.params;
const plan = (plans as any[]).find((p) => p.id === id);
if (!plan) {
  return Astro.redirect("/plans");
}

const parsedDay = Number.parseInt(day ?? "", 10);
if (
  !Number.isFinite(parsedDay) ||
  parsedDay < 1 ||
  parsedDay > plan.durationDays
) {
  return Astro.redirect(`/plans/${id}`);
}

// Cargar contenido din√°mico del plan si existe
let dayContent = {
  title: "",
  bible: [],
  egw: [],
  description: "",
};

try {
  const response = await fetch(new URL(`/data/plan-content/${id}.json`, Astro.url));
  if (response.ok) {
    const data = await response.json();
    if (data[parsedDay]) {
      dayContent = data[parsedDay];
    }
  }
} catch (e) {
  console.error("Error loading plan content:", e);
}

const readings = dayContent.bible || [];
const egwReadings = dayContent.egw || [];
---

<ReaderLayout>
  <PlanDay
    client:only="preact"
    planId={plan.id}
    planTitle={plan.title}
    day={parsedDay}
    readings={readings}
    egwReadings={egwReadings}
    description={dayContent.description}
    dayTitle={dayContent.title}
  />
</ReaderLayout>